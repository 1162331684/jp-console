<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jeeplus.qc.mapper.QcTrfMapper">

	<sql id="qcTrfColumns">
		a.id AS "id",
		a.trf_id AS "trfId",
		a.bno AS "bno",
		a.mo AS "mo",
		a.working_no AS "workingNo",
		a.article AS "article",
		a.season AS "season",
		a.status AS "status",
		if(ifnull(a.status,'') = 'pass' or ifnull(a.status,'') = 'nopass' ,'Completed',ifnull(ts.label,a.status)) taskStatus,
		if(ifnull(a.status,'') != 'pass' and ifnull(a.status,'') != 'nopass' ,'',ifnull(ts.label,a.status)) resultStatus,
		a.change_time AS "changeTime",
		a.remarks AS "remarks",
		a.create_by AS "createBy",
		a.create_date AS "createDate",
		a.update_by AS "updateBy",
		a.update_date AS "updateDate",
		a.del_flag AS "delFlag",
		a.type AS "type",
		a.factory AS "factory",
		a.barcode AS "barcode",
		a.sample_code AS "sampleCode",
		a.sample_name AS "sampleName",
		a.merchandiser AS "merchandiser",
		a.sample_type AS "sampleType",
		a.atp_status AS "atpStatus",
		a.lab1st_level AS "lab1stLevel",
		a.lab2nd_level AS "lab2ndLevel",
		a.lab3rd_level AS "lab3rdLevel",
		a.lab4th_level AS "lab4thLevel",
		a.lab1st_level_status AS "lab1stLevelStatus",
		a.lab2nd_level_status AS "lab2ndLevelStatus",
		a.lab3rd_level_status AS "lab3rdLevelStatus",
		a.lab4th_level_status AS "lab4thLevelStatus",
		u1.id AS "lab1stLevelUser.id",
		u1.name AS "lab1stLevelUser.name",
		a.lab1st_level AS "lab1stLevelUser.loginName",
		u2.id AS "lab2ndLevelUser.id",
		u2.name AS "lab2ndLevelUser.name",
		a.lab2nd_level AS "lab2ndLevelUser.loginName",
		u3.id AS "lab3rdLevelUser.id",
		u3.name AS "lab3rdLevelUser.name",
		a.lab3rd_level AS "lab3rdLevelUser.loginName",
		u4.id AS "lab4thLevelUser.id",
		u4.name AS "lab4thLevelUser.name",
		a.lab4th_level AS "lab4thLevelUser.loginName",
		a.test_results_date AS "testResultsDate",
		a.source AS "source",
		a.submitter_id AS "submitterId",
		a.submitter_id AS "submitter.id",
		str.name AS "submitter.name",
		str.login_name AS "submitter.loginName"
	</sql>
	<sql id="qcTrfJoins">
	left join (
		select v.value,v.label
		from sys_dict_type t
		left join sys_dict_value v on t.id = v.dict_type_id
		where t.type='trf_status'
	) ts on ts.value = a.status
	left join sys_user u1 on a.lab1st_level = u1.login_name
	left join sys_user u2 on a.lab2nd_level = u2.login_name
	left join sys_user u3 on a.lab3rd_level = u3.login_name
	left join sys_user u4 on a.lab4th_level = u4.login_name
	left join sys_user str on a.submitter_id = str.id
	</sql>
	<select id="hasSpecimenById" resultType="java.lang.Integer">
		SELECT count(*)
		FROM qc_trf_item_specimen b
		where qc_trf_item_id in (
			SELECT a.id
			FROM qc_trf_item a
			JOIN qc_trf b ON b.id = a.qc_trf_id
			WHERE b.id = #{id} and a.del_flag = 0
		)  and b.del_flag = 0
	</select>
	
	<select id="getIdsByItemIds" resultType="java.lang.String">
		SELECT DISTINCT  t.id
		from qc_trf t
		join qc_trf_item ti on t.id=ti.qc_trf_id
		where ti.id in('${trfItemIds}')
	</select>


	<select id="getIdsBySpecimenIds" resultType="java.lang.String">
		SELECT DISTINCT  t.id
		from qc_trf t
		join qc_trf_item ti on t.id=ti.qc_trf_id
		join qc_trf_item_specimen tis on tis.qc_trf_item_id = ti.id
		where tis.id in ('${specimenIds}')
	</select>

	<select id="findListByAppSync" resultType="com.jeeplus.qc.domain.QcTrf">
		SELECT
		<include refid="qcTrfColumns"/>
		FROM qc_trf a
		<include refid="qcTrfJoins"/>
		LEFT JOIN (
			select id,name,company_id
			from sys_user
			where del_flag = 0
		) createBy on a.create_by = createBy.id
		WHERE 1=1
		<if test="updateDateStart != null and updateDateStart !='' ">
			AND a.update_date >= '${updateDateStart}'
		</if>
		<if test="updateDateEnd != null and updateDateEnd !='' ">
			AND '${updateDateEnd}' >= a.update_date
		</if>
		<if test="status != null and status !='' ">
			AND a.status in ('${status}')
		</if>
		<if test="factory != null and factory !='' ">
			AND a.factory in ('${factory}')
		</if>
		<if test="createBy != null and createBy.companyDTO != null and createBy.companyDTO.id != null and createBy.companyDTO.id !='' ">
			AND createBy.company_id = '${createBy.companyDTO.id}'
		</if>
	</select>

	<select id="findList" resultType="com.jeeplus.qc.domain.QcTrf">
		SELECT
		<include refid="qcTrfColumns"/>
		FROM qc_trf a
		<include refid="qcTrfJoins"/>
		${ew.customSqlSegment}
	</select>
	<select id="findDTOList" resultType="com.jeeplus.qc.service.dto.QcTrfDTO">
		SELECT
			a.create_by AS "createBy.id",
			createBy.name AS "createBy.name",
			a.update_by AS "updateBy.id",
			updateBy.name AS "updateBy.name",
			<include refid="qcTrfColumns"/>
		FROM qc_trf a
		<include refid="qcTrfJoins"/>
		LEFT JOIN (
			select id,name,company_id
			from sys_user
			where del_flag = 0
		) createBy on a.create_by = createBy.id
		LEFT JOIN (
			select id,name
			from sys_user
			where del_flag = 0
		) updateBy on a.update_by = updateBy.id
		WHERE a.del_flag = 0
		<if test="status != null and status !='' ">
			AND a.status in ('${status}')
		</if>
		<if test="id != null and id !='' ">
			AND a.id in ('${id}')
		</if>
	</select>
	<select id="findDTOPage" resultType="com.jeeplus.qc.service.dto.QcTrfDTO">
		SELECT
			a.create_by AS "createBy.id",
			createBy.name AS "createBy.name",
			a.update_by AS "updateBy.id",
			updateBy.name AS "updateBy.name",
			<include refid="qcTrfColumns"/>
		FROM qc_trf a
		<include refid="qcTrfJoins"/>
		LEFT JOIN (
		    select id,name,company_id
		    from sys_user
		    where del_flag = 0
		) createBy on a.create_by = createBy.id
		LEFT JOIN (
			select id,name
			from sys_user
			where del_flag = 0
		) updateBy on a.update_by = updateBy.id
		${ew.customSqlSegment}
	</select>


</mapper>
